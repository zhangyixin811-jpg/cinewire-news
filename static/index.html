<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Film Festival Information</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Manrope:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- CSS 部分 --- */
        :root { --bg: #030303; --card-bg: #0a0a0a; --text: #f0f0f0; --muted: #666666; --gold: #D4AF37; --border: rgba(255, 255, 255, 0.08); --hover: rgba(255, 255, 255, 0.05); --font-head: 'Cinzel', serif; --font-ui: 'Manrope', sans-serif; --ease: cubic-bezier(0.23, 1, 0.32, 1); }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background-color: var(--bg); color: var(--text); font-family: var(--font-ui); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        body::after { content: ""; position: absolute; inset: 0; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E"); pointer-events: none; z-index: 999; opacity: 0.5; }

        header { flex-shrink: 0; border-bottom: 1px solid var(--border); background: rgba(3, 3, 3, 0.95); backdrop-filter: blur(10px); z-index: 100; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: var(--font-head); font-size: 1.6rem; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--text); }
        .controls-wrapper { display: flex; flex-direction: column; align-items: flex-end; gap: 12px; }
        .refresh-btn { background: var(--card-bg); border: 1px solid var(--border); color: var(--text); padding: 6px 18px; border-radius: 20px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.4s var(--ease); display: flex; align-items: center; gap: 8px; }
        .refresh-btn:hover { border-color: var(--gold); color: var(--gold); } .refresh-btn:hover i { transform: rotate(180deg); } .refresh-btn i { transition: transform 0.5s; }
        .btn-group { display: flex; gap: 12px; align-items: center; }
        .ui-btn { background: transparent; border: 1px solid var(--border); color: var(--muted); padding: 8px 14px; font-family: var(--font-ui); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; transition: all 0.3s var(--ease); display: flex; align-items: center; gap: 8px; border-radius: 4px; }
        .ui-btn:hover, .ui-btn.active { border-color: var(--text); color: var(--text); background: var(--hover); }
        .ui-btn.accent.active { border-color: var(--gold); color: var(--gold); }
        select.ui-select { background: transparent; border: none; color: inherit; font: inherit; cursor: pointer; appearance: none; padding-right: 15px; text-transform: uppercase; }

        .layout { display: flex; height: 100%; overflow: hidden; }
        aside { width: 260px; border-right: 1px solid var(--border); padding: 40px 0; display: flex; flex-direction: column; gap: 5px; overflow-y: auto; flex-shrink: 0; }
        .nav-header { padding: 0 30px 10px 30px; font-size: 0.7rem; color: var(--muted); text-transform: uppercase; letter-spacing: 2px; opacity: 0.6; margin-top: 5px; }
        .nav-header.secondary { margin-top: 25px; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.03); margin-bottom: 5px; margin-left: 30px; margin-right: 30px; padding-left: 0; }
        .fest-btn { padding: 14px 30px; text-align: left; background: transparent; border: none; color: var(--muted); font-family: var(--font-ui); font-size: 0.9rem; cursor: pointer; border-left: 2px solid transparent; transition: all 0.3s; display: block; width: 100%; }
        .fest-btn:hover { color: var(--text); background: var(--hover); }
        .fest-btn.active { color: var(--text); border-left-color: var(--gold); background: linear-gradient(90deg, rgba(212, 175, 55, 0.05), transparent); }

        main { flex: 1; overflow-y: auto; padding: 0; scroll-behavior: smooth; }
        .feed-container { max-width: 1400px; margin: 0 auto; padding: 50px 60px 100px 60px; display: flex; flex-direction: column; min-height: 100%; }
        .page-title { font-family: var(--font-head); font-size: 3rem; font-weight: 400; margin-bottom: 40px; opacity: 0; animation: fadeIn 0.8s var(--ease) forwards; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 30px; flex: 1; }

        /* Card Styles */
        .card { background: var(--card-bg); border: 1px solid var(--border); padding: 30px; min-height: 260px; display: flex; flex-direction: column; cursor: pointer; position: relative; transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .card:hover { transform: translateY(-6px); background-color: #141414; border-color: rgba(255, 255, 255, 0.4); box-shadow: 0 20px 50px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05); }
        .card-header { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 25px; height: 32px; }
        .card-meta-group { display: flex; align-items: center; gap: 15px; }
        .card-date { font-family: monospace; font-size: 0.75rem; color: #555; transition: color 0.3s; }
        .card:hover .card-date { color: #888; }
        .card-fav-btn { background: transparent; border: none; color: #444; font-size: 1.1rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; padding: 8px; margin: -8px; z-index: 10; }
        .card-fav-btn:hover { color: var(--text); transform: scale(1.1); text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .card-fav-btn.active { color: var(--gold); }
        .card h3 { font-family: var(--font-head); font-size: 1.4rem; line-height: 1.3; font-weight: 400; color: #ddd; margin-bottom: 15px; transition: color 0.3s; }
        .card:hover h3 { color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .card-excerpt { font-size: 0.85rem; color: #666; line-height: 1.6; flex-grow: 1; margin-bottom: 20px; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; transition: color 0.3s; }
        .card:hover .card-excerpt { color: #999; }
        .card-footer { border-top: 1px solid rgba(255,255,255,0.05); padding-top: 15px; font-size: 0.75rem; color: #444; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; transition: border-color 0.3s; }
        .card:hover .card-footer { border-top-color: rgba(255,255,255,0.15); color: #888; }
        
        /* 底部加载指示器 */
        .loader { padding: 40px 0; text-align: center; color: #444; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; width: 100%; display: none; }
        .end-message { padding: 40px 0; text-align: center; color: #444; font-size: 0.7rem; letter-spacing: 1px; text-transform: uppercase; width: 100%; display: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <header>
        <div class="logo" id="site-name">Global Film Festival Information</div>
        <div class="controls-wrapper">
            <button class="refresh-btn" onclick="app.refreshFeed()">
                <i class="fa-solid fa-rotate-right"></i> <span id="txt-refresh">Refresh Feed</span>
            </button>
            <div class="btn-group">
                <button class="ui-btn accent" id="btn-favs" onclick="app.toggleFavoritesView()">
                    <i class="fa-solid fa-heart"></i> <span id="txt-fav">Favorites</span>
                </button>
                <button class="ui-btn">
                    <i class="fa-solid fa-arrow-down-wide-short"></i>
                    <select class="ui-select" id="sort-select" onchange="app.loadSortedFeed(this.value)">
                        <option value="latest">Latest</option>
                        <option value="hottest">Hottest</option>
                    </select>
                </button>
                <button class="ui-btn" onclick="app.toggleLang()">
                    <i class="fa-solid fa-globe"></i> <span id="txt-lang">EN</span>
                </button>
            </div>
        </div>
    </header>

    <div class="layout">
        <aside>
            <div class="nav-header" id="nav-head-main">Official Sources</div>
            <div id="sidebar-list"></div>
        </aside>
        <main id="main-scroll">
            <div class="feed-container">
                <h1 class="page-title" id="feed-title">Global Headlines</h1>
                
                <div class="news-grid" id="news-grid"></div>
                
                <div id="loader" class="loader">Loading more updates...</div>
                <div id="end-message" class="end-message">End of Transmission</div>
            </div>
        </main>
    </div>

    <script>
        const dictionary = {
            en: {
                title: "Global Film Festival Information", navHeader: "Official Sources", recHeader: "Recommended Festivals",
                refresh: "Refresh Feed", fav: "Favorites", latest: "Latest", hottest: "Hottest", loading: "Gathering Data...", loadingMore: "Loading more...",
                end: "End of Transmission", noFavs: "No saved articles.", source: "Official Source", read: "Read Entry", headlines: "Global Headlines", favTitle: "My Favorites",
                festivals: { all: "All Festivals", sundance: "Sundance", berlin: "Berlinale", cannes: "Cannes", venice: "Venice", tiff: "TIFF", sxsw: "SXSW" }
            },
            cn: {
                title: "全球电影节资讯", navHeader: "官方来源", recHeader: "推荐电影节",
                refresh: "刷新内容", fav: "我的收藏", latest: "最新发布", hottest: "热门排行", loading: "正在抓取数据...", loadingMore: "正在加载更多...",
                end: "内容已全部加载", noFavs: "暂无收藏文章。", source: "官方来源", read: "阅读原文", headlines: "全球头条", favTitle: "我的收藏",
                festivals: { all: "全部电影节", sundance: "圣丹斯", berlin: "柏林电影节", cannes: "戛纳电影节", venice: "威尼斯电影节", tiff: "多伦多电影节", sxsw: "西南偏南" }
            }
        };

        const app = {
            lang: 'en', filter: 'latest', currentFest: 'all', isFavView: false, favorites: new Set(),
            
            // 无限滚动状态管理
            articles: [],
            currentPage: 1,
            isLoading: false,
            hasMore: true,

            init() {
                this.renderSidebar();
                this.loadData(1, false); // 初始加载第1页，非追加模式
                this.setupInfiniteScroll();
            },

            // --- 核心：加载数据 ---
            async loadData(page, isAppend) {
                if (this.isLoading) return; // 防止重复触发
                this.isLoading = true;
                
                const loader = document.getElementById('loader');
                const endMsg = document.getElementById('end-message');
                const grid = document.getElementById('news-grid');
                
                loader.style.display = 'block';
                loader.innerText = isAppend ? dictionary[this.lang].loadingMore : dictionary[this.lang].loading;
                endMsg.style.display = 'none';

                if (!isAppend) {
                    grid.innerHTML = ''; // 清空列表
                    this.currentPage = 1;
                    this.hasMore = true;
                }

                try {
                    // 发送排序参数 (sort) 给后端
                    const res = await fetch(`/api/news/${this.currentFest}?page=${page}&sort=${this.filter}`);
                    if (!res.ok) throw new Error("Backend Error");
                    
                    const responseData = await res.json();
                    const newArticles = responseData.articles;
                    
                    // 更新状态
                    this.hasMore = responseData.meta.has_more;
                    
                    if (isAppend) {
                        this.articles = [...this.articles, ...newArticles];
                    } else {
                        this.articles = newArticles;
                        document.getElementById('main-scroll').scrollTop = 0; // 回到顶部
                    }
                    
                    this.renderFeed(newArticles, isAppend);

                } catch (error) {
                    if(!isAppend) grid.innerHTML = '<div style="color:#666; text-align:center; grid-column:1/-1;">Connection Failed.</div>';
                } finally {
                    this.isLoading = false;
                    loader.style.display = 'none';
                    if (!this.hasMore) endMsg.style.display = 'block';
                }
            },

            // --- 监听滚动 ---
            setupInfiniteScroll() {
                const main = document.getElementById('main-scroll');
                main.addEventListener('scroll', () => {
                    // 如果在加载中、或者是收藏页、或者没有更多数据了，就不动作
                    if (this.isLoading || this.isFavView || !this.hasMore) return;

                    // 距离底部 100px 时触发加载
                    if (main.scrollTop + main.clientHeight >= main.scrollHeight - 100) {
                        this.currentPage++;
                        this.loadData(this.currentPage, true); // 追加模式
                    }
                });
            },

            // --- 切换排序 (触发重新加载) ---
            loadSortedFeed(val) {
                this.filter = val;
                // 排序改变了，必须从第1页重新向后端请求，因为"最热"可能会改变整个列表的顺序
                this.loadData(1, false); 
            },

            renderFeed(articlesToRender, isAppend) {
                const grid = document.getElementById('news-grid');
                const t = dictionary[this.lang];
                
                // 如果是收藏页，渲染本地过滤的数据
                if (this.isFavView) {
                    grid.innerHTML = '';
                    const favData = this.articles.filter(a => this.favorites.has(a.id));
                    if (favData.length === 0) {
                        grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; color:#555; padding:50px;">${t.noFavs}</div>`;
                        return;
                    }
                    articlesToRender = favData;
                }

                // 渲染卡片
                articlesToRender.forEach((art, i) => {
                    const el = document.createElement('div');
                    el.className = 'card';
                    // 如果是追加加载，给点小动画
                    el.style.animation = `fadeIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards ${i * 0.05}s`;
                    el.style.opacity = '0';
                    el.onclick = (e) => window.open(art.link, '_blank');

                    const isFav = this.favorites.has(art.id);
                    const displayTitle = this.lang === 'cn' ? (art.title_cn || art.title_en) : art.title_en;
                    const displayDesc = this.lang === 'cn' ? (art.desc_cn || art.desc_en) : art.desc_en;
                    
                    el.innerHTML = `
                        <div class="card-header">
                            <div class="card-meta-group">
                                <span class="card-date">${art.date}</span>
                                <button class="card-fav-btn ${isFav ? 'active' : ''}" onclick="app.toggleFav('${art.id}', this, event)">
                                    <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                                </button>
                            </div>
                        </div>
                        <h3>${displayTitle}</h3>
                        <p class="card-excerpt">${displayDesc}</p>
                        <div class="card-footer">
                            <span>${t.source}</span>
                            <span>${t.read} &rarr;</span>
                        </div>
                    `;
                    grid.appendChild(el);
                });
            },

            toggleLang() {
                this.lang = this.lang === 'en' ? 'cn' : 'en';
                const t = dictionary[this.lang];

                document.getElementById('site-name').innerText = t.title;
                document.getElementById('nav-head-main').innerText = t.navHeader;
                document.getElementById('txt-refresh').innerText = t.refresh;
                document.getElementById('txt-fav').innerText = t.fav;
                document.getElementById('txt-lang').innerText = this.lang.toUpperCase();
                document.getElementById('end-message').innerText = t.end;
                
                const sel = document.getElementById('sort-select');
                sel.options[0].text = t.latest;
                sel.options[1].text = t.hottest;

                this.renderSidebar();
                
                const mainTitle = this.isFavView ? t.favTitle : (this.currentFest === 'all' ? t.headlines : t.festivals[this.currentFest]);
                document.getElementById('feed-title').innerText = mainTitle;
                
                // 重新渲染当前 DOM 中的卡片以更新语言
                const grid = document.getElementById('news-grid');
                grid.innerHTML = ''; 
                this.renderFeed(this.articles, true); 
            },

            renderSidebar() {
                const list = document.getElementById('sidebar-list');
                const t = dictionary[this.lang];
                list.innerHTML = '';
                
                const allBtn = document.createElement('button');
                allBtn.className = `fest-btn ${this.currentFest === 'all' ? 'active' : ''}`;
                allBtn.innerText = t.festivals['all'];
                allBtn.onclick = () => this.filterFest('all');
                list.appendChild(allBtn);

                const recHeader = document.createElement('div');
                recHeader.className = 'nav-header secondary';
                recHeader.innerText = t.recHeader;
                list.appendChild(recHeader);
                
                ['sundance', 'berlin', 'cannes', 'venice', 'tiff', 'sxsw'].forEach(key => {
                    const btn = document.createElement('button');
                    btn.className = `fest-btn ${this.currentFest === key ? 'active' : ''}`;
                    btn.innerText = t.festivals[key];
                    btn.onclick = () => this.filterFest(key);
                    list.appendChild(btn);
                });
            },

            toggleFav(id, btn, e) {
                e.stopPropagation();
                if (this.favorites.has(id)) {
                    this.favorites.delete(id);
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="fa-regular fa-heart"></i>';
                    if (this.isFavView) {
                         // 在收藏页取消收藏，直接移除该元素
                         btn.closest('.card').style.display = 'none';
                    }
                } else {
                    this.favorites.add(id);
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fa-solid fa-heart"></i>';
                }
            },

            toggleFavoritesView() {
                this.isFavView = !this.isFavView;
                const btn = document.getElementById('btn-favs');
                const t = dictionary[this.lang];
                const loader = document.getElementById('loader');
                const endMsg = document.getElementById('end-message');

                if (this.isFavView) {
                    btn.classList.add('active');
                    document.getElementById('feed-title').innerText = t.favTitle;
                    loader.style.display = 'none';
                    endMsg.style.display = 'none';
                } else {
                    btn.classList.remove('active');
                    document.getElementById('feed-title').innerText = this.currentFest === 'all' ? t.headlines : t.festivals[this.currentFest];
                }
                // 渲染
                const grid = document.getElementById('news-grid');
                grid.innerHTML = '';
                this.renderFeed(this.articles, false);
            },

            refreshFeed() {
                const icon = document.querySelector('.refresh-btn i');
                icon.style.transition = 'transform 1s';
                icon.style.transform = 'rotate(360deg)';
                setTimeout(() => {
                    icon.style.transition = 'none';
                    icon.style.transform = 'rotate(0deg)';
                    this.loadData(1, false);
                }, 800);
            },

            filterFest(id) {
                this.currentFest = id;
                this.isFavView = false;
                document.getElementById('btn-favs').classList.remove('active');
                
                const t = dictionary[this.lang];
                const festName = t.festivals[id];
                document.getElementById('feed-title').innerText = id === 'all' ? t.headlines : festName;
                
                this.renderSidebar();
                this.loadData(1, false);
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
</body>

</html>
